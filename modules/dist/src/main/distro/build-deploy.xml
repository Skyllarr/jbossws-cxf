<?xml version="1.0" encoding="UTF-8"?>

<!--
  ~ JBoss, Home of Professional Open Source.
  ~ Copyright 2014, Red Hat, Inc., and individual contributors
  ~ as indicated by the @author tags. See the copyright.txt file in the
  ~ distribution for a full listing of individual contributors.
  ~
  ~ This is free software; you can redistribute it and/or modify it
  ~ under the terms of the GNU Lesser General Public License as
  ~ published by the Free Software Foundation; either version 2.1 of
  ~ the License, or (at your option) any later version.
  ~
  ~ This software is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
  ~ Lesser General Public License for more details.
  ~
  ~ You should have received a copy of the GNU Lesser General Public
  ~ License along with this software; if not, write to the Free
  ~ Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
  ~ 02110-1301 USA, or see the FSF site: http://www.fsf.org.
  -->

<project>

  <!-- ================================================================== -->
  <!-- Prepare Deployment Structure WildFly-8.0.x                         -->
  <!-- ================================================================== -->

  <target name="deploy-structure-wildfly80x" depends="prepare-deploy">
    <delete dir="${deploy.structure}"/>

    <path id="jboss.ant.tasks.classpath">
      <fileset dir="${deploy.artifacts.dir}">
        <include name="**/jbossws-common-tools.jar"/>
        <include name="**/jandex.jar"/>
      </fileset>
    </path>
    <taskdef name="installModules" classname="org.jboss.ws.tools.ant.InstallModulesTask" classpathref="jboss.ant.tasks.classpath"/>
    <taskdef name="jandex" classname="org.jboss.jandex.JandexAntTask" classpathref="jboss.ant.tasks.classpath"/>

    <jandex run="true" verbose="false" newJar="true">
      <fileset dir="${deploy.artifacts.dir}/lib">
        <include name="cxf*security.jar"/>
      </fileset>
    </jandex>
    <antcall target="deploy-jbossws-cxf-modules-as8" inheritall="false">
      <param name="installserver" value="${deploy.structure}/modules/system/layers/base"/>
      <param name="thirdpartydir" value="${deploy.artifacts.dir}"/>
      <param name="jbossid" value="${jbossws.integration.target}"/>
      <param name="modules-jbossid" value="wildfly800"/>
    </antcall>
  	<copy toDir="${deploy.structure}/modules/system/layers/base">
      <fileset dir="${deploy.artifacts.dir}/modules/wildfly800">
        <include name="**/jboss/as/webservices/main/module.xml"/>
      	<include name="**/jboss/as/webservices/server/integration/main/module.xml"/>
      </fileset>
    </copy>
  </target>

  <!-- ================================================================== -->
  <!-- Deployment wildfly800                                              -->
  <!-- ================================================================== -->

  <target name="target-wildfly800">
    <property name="jbossws.integration.target" value="wildfly800"/>
    <echo message="jbossws.integration.target=${jbossws.integration.target}" file="${target.properties.file}"/>
  </target>

  <target name="deploy-wildfly800" depends="undeploy-wildfly800,deploy-structure-wildfly80x,check-spring,install-spring-module80x" description="Deploy jbossws to wildfly800">
    <fail message="Not available: ${wildfly800.available.file}" unless="wildfly800.available"/>
    <copy todir="${wildfly800.home}" overwrite="true" verbose="true">
      <fileset dir="${deploy.structure}">
        <exclude name="**/jboss/as/webservices/**/module.xml"/>
      </fileset>
    </copy>
    <!-- Install org/jboss/as/webservices module.xml separately since it needs to reference libs already on the AS -->
    <installModules targetDir="${wildfly800.home}/modules/system/layers/base/">
      <fileset dir="${deploy.structure}/modules/system/layers/base">
        <include name="**/jboss/as/webservices/**/module.xml"/>
      </fileset>
    </installModules>
  </target>

  <target name="undeploy-wildfly800" depends="target-wildfly800,init" description="Remove jbossws from wildfly800">
    <fail message="Not available: ${wildfly800.available.file}" unless="wildfly800.available"/>
    <macro-undeploy-jbossws-modules targetdir="${wildfly800.home}/modules/system/layers/base" defaultmodulesconf="${jbossws.default.modules.conf}" modifyjbossintegration="true"/>
  </target>

  <!-- ================================================================== -->
  <!-- Deployment wildfly810                                              -->
  <!-- ================================================================== -->

  <target name="target-wildfly810">
    <property name="jbossws.integration.target" value="wildfly810"/>
    <echo message="jbossws.integration.target=${jbossws.integration.target}" file="${target.properties.file}"/>
  </target>

  <target name="deploy-wildfly810" depends="undeploy-wildfly810,deploy-structure-wildfly80x,check-spring,install-spring-module80x" description="Deploy jbossws to wildfly810">
    <fail message="Not available: ${wildfly810.available.file}" unless="wildfly810.available"/>
    <copy todir="${wildfly810.home}" overwrite="true" verbose="true">
      <fileset dir="${deploy.structure}">
        <exclude name="**/jboss/as/webservices/**/module.xml"/>
      </fileset>
    </copy>
    <!-- Install org/jboss/as/webservices module.xml separately since it needs to reference libs already on the AS -->
    <installModules targetDir="${wildfly810.home}/modules/system/layers/base/">
      <fileset dir="${deploy.structure}/modules/system/layers/base">
        <include name="**/jboss/as/webservices/**/module.xml"/>
      </fileset>
    </installModules>
  </target>

  <target name="undeploy-wildfly810" depends="target-wildfly810,init" description="Remove jbossws from wildfly810">
    <fail message="Not available: ${wildfly810.available.file}" unless="wildfly810.available"/>
    <macro-undeploy-jbossws-modules targetdir="${wildfly810.home}/modules/system/layers/base" defaultmodulesconf="${jbossws.default.modules.conf}" modifyjbossintegration="true"/>
  </target>

  <!-- ================================================================== -->
  <!-- Prepare Deployment Structure WildFly-9.0.x                         -->
  <!-- ================================================================== -->

  <target name="deploy-structure-wildfly90x" depends="prepare-deploy">
    <delete dir="${deploy.structure}"/>
	    <path id="jboss.ant.tasks.classpath">
      <fileset dir="${deploy.artifacts.dir}">
        <include name="**/jbossws-common-tools.jar"/>
        <include name="**/jandex.jar"/>
      </fileset>
    </path>
    <taskdef name="installModules" classname="org.jboss.ws.tools.ant.InstallModulesTask" classpathref="jboss.ant.tasks.classpath"/>
    <taskdef name="jandex" classname="org.jboss.jandex.JandexAntTask" classpathref="jboss.ant.tasks.classpath"/>
	    <jandex run="true" verbose="false" newJar="true">
      <fileset dir="${deploy.artifacts.dir}/lib">
        <include name="cxf*security.jar"/>
      </fileset>
    </jandex>
    <antcall target="deploy-jbossws-cxf-modules-as9" inheritall="false">
      <param name="installserver" value="${deploy.structure}/modules/system/layers/base"/>
      <param name="thirdpartydir" value="${deploy.artifacts.dir}"/>
      <param name="jbossid" value="${jbossws.integration.target}"/>
      <param name="modules-jbossid" value="wildfly900"/>
    </antcall>
  	<copy toDir="${deploy.structure}/modules/system/layers/base">
      <fileset dir="${deploy.artifacts.dir}/modules/wildfly900">
        <include name="**/jboss/as/webservices/main/module.xml"/>
      	<include name="**/jboss/as/webservices/server/integration/main/module.xml"/>
      </fileset>
    </copy>
  </target>

  <!-- ================================================================== -->
  <!-- Deployment wildfly900                                              -->
  <!-- ================================================================== -->

  <target name="target-wildfly900">
    <property name="jbossws.integration.target" value="wildfly900"/>
    <echo message="jbossws.integration.target=${jbossws.integration.target}" file="${target.properties.file}"/>
  </target>
  <target name="deploy-wildfly900" depends="undeploy-wildfly900,deploy-structure-wildfly90x,check-spring,install-spring-module90x" description="Deploy jbossws to wildfly900">
    <fail message="Not available: ${wildfly900.available.file}" unless="wildfly900.available"/>
    <copy todir="${wildfly900.home}" overwrite="true" verbose="true">
      <fileset dir="${deploy.structure}">
        <exclude name="**/jboss/as/webservices/**/module.xml"/>
      </fileset>
    </copy>
    <!-- Install org/jboss/as/webservices module.xml separately since it needs to reference libs already on the AS -->
    <installModules targetDir="${wildfly900.home}/modules/system/layers/base/">
      <fileset dir="${deploy.structure}/modules/system/layers/base">
        <include name="**/jboss/as/webservices/**/module.xml"/>
      </fileset>
    </installModules>
  </target>

  <target name="undeploy-wildfly900" depends="target-wildfly900,init" description="Remove jbossws from wildfly900">
    <fail message="Not available: ${wildfly900.available.file}" unless="wildfly900.available"/>
    <macro-undeploy-jbossws-modules targetdir="${wildfly900.home}/modules/system/layers/base" defaultmodulesconf="${jbossws.default.modules.conf}" modifyjbossintegration="false"/>
  </target>

  <!-- ================================================================== -->
  <!-- Spring                                                             -->
  <!-- ================================================================== -->
  <target name="check-spring">
    <condition property="spring-required">
      <and>
        <istrue value="${spring}"/>
      </and>
    </condition>
  </target>

  <target name="install-spring-module80x" if="spring-required">
    <antcall target="deploy-spring-module" inheritall="false">
      <param name="installserver" value="${deploy.structure}/modules/system/layers/base"/>
      <param name="thirdpartydir" value="${deploy.artifacts.dir}"/>
      <param name="modules-jbossid" value="wildfly800"/>
    </antcall>
  </target>

  <target name="install-spring-module90x" if="spring-required">
    <antcall target="deploy-spring-module" inheritall="false">
      <param name="installserver" value="${deploy.structure}/modules/system/layers/base"/>
      <param name="thirdpartydir" value="${deploy.artifacts.dir}"/>
      <param name="modules-jbossid" value="wildfly900"/>
    </antcall>
  </target>

</project>
